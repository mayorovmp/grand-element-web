<ngx-smart-modal 
    #requestEditorModal 
    identifier="requestEditorModal" 
    (onOpen)="onOpen()"
>
    <div class="form-container">
        <h2 class="form-title">Редактор</h2>
        <div class="form-block">
            <label for="clients" class="form-block__label">
              Клиент
            </label>
            <select 
                [disabled]="isShort" 
                class="form-block__select"
                id="clients"
                [(ngModel)]="request.client" 
                [compareWith]="byId" 
                (change)="onClientChange()"
            >
                <option [ngValue]="undefined"></option>
                <option *ngFor="let client of clients" [ngValue]="client">
                    {{client.name}}
                </option>
            </select>
            <i (click)="addClient()" class="ml-2 fa fa-plus" aria-hidden="true"></i>
        </div>
        <div class="form-block">
            <label for="deliveryAddress" class="form-block__label">
                Адрес доставки
            </label>
            <select 
                [disabled]="!request.client || isShort" 
                class="form-block__select" 
                [(ngModel)]="request.deliveryAddress"
                id="deliveryAddress"
                [compareWith]="byId"
                (change)="onAddrChange()"
            >
                <option [ngValue]="undefined"></option>
                <option *ngFor="let address of request.client?.addresses" [ngValue]="address">
                    {{address.name}}
                </option>
            </select>
        </div>
        <div class="form-block">
            <label for="longTermCheckbox" class="form-block__label">
                Долгосрочная заявка
            </label>
            <input 
                [disabled]="isShort" 
                type="checkbox" 
                class="form-block__input" 
                id="longTermCheckbox"
                [(ngModel)]="request.isLong"
            >
        </div>
        <div class="form-block" *ngIf="request.isLong">
            <label for="deliveryStart" class="form-block__label">
                Дата с
            </label>
            <input 
                type="date" 
                name="bday" 
                [ngModel]="request.deliveryStart | date:'yyyy-MM-dd'"
                (ngModelChange)="request.deliveryStart = $event" 
                min="1000-01-01" 
                max="3000-12-31" 
                id="deliveryStart"
                class="form-block__input" 
            >
        </div>
        <div class="form-block" *ngIf="request.isLong">
            <label for="deliveryEnd" class="form-block__label">
                Дата по
            </label>
            <input 
                type="date" 
                name="bday" 
                [ngModel]="request.deliveryEnd | date:'yyyy-MM-dd'"
                (ngModelChange)="request.deliveryEnd = $event" 
                min="1000-01-01" 
                max="3000-12-31" 
                id="deliveryEnd"
                class="form-block__input" 
            >
        </div>
        <div class="form-block">
            <label for="amount" class="form-block__label">
                Объем, тн
            </label>
            <input 
                type="number" 
                [(ngModel)]="request.amount" 
                id="amount"
                class="form-block__input"
            >
        </div>
        <div class="form-block">
            <label for="sellingPrice" class="form-block__label">
                Цена продажи
            </label>
            <input 
                type="number" 
                [(ngModel)]="request.sellingPrice" 
                class="form-block__input" 
                id="sellingPrice"
                (change)="onSellingPriceChange()"
            >
        </div>
        <div class="form-block">
            <label for="product" class="form-block__label">
                Товар
            </label>
            <select 
                [disabled]="isShort" 
                class="form-block__select" 
                [(ngModel)]="request.product"
                (ngModelChange)="onProductChange(request.product?.id)" 
                id="product"
                [compareWith]="byId"
            >
                <option [ngValue]="undefined"></option>
                <option *ngFor="let product of products" [ngValue]="product">
                    {{product.name}}
                </option>
            </select>
        </div>

        <div *ngIf="!request.isLong" class="form-block-adding-block">
            <div class="form-block">
                <label for="supplier" class="form-block__label">
                    Поставщик
                </label>
                <select 
                    class="form-block__input" 
                    [(ngModel)]="request.supplier" 
                    id="exampleFormControlSelect1"
                    (ngModelChange)="onSupplierChange()" 
                    [compareWith]="byId"
                >
                    <option [ngValue]="undefined"></option>
                    <option *ngFor="let supplier of suppliers" [ngValue]="supplier">
                        {{supplier.name}}
                    </option>
                </select>
                <i (click)="addSupplier()" class="ml-2 fa fa-plus" aria-hidden="true"></i>
            </div>
            <div class="form-block">
                <label for="supplierVat" class="form-block__label">
                    Поставщик без НДС
                </label>
                <input 
                    disabled 
                    type="checkbox" 
                    [ngModel]="request.supplierVat" 
                    id="supplierVat"
                    class="form-block__input"
                >
            </div>
            <div class="form-block">
                <label for="purchasePrice" class="form-block__label">
                    Цена закупки
                </label>
                <input 
                    disabled 
                    type="number" 
                    [ngModel]="request.purchasePrice" 
                    class="form-block__input"
                    (change)="calcSellingCost()"
                >
            </div>
            <div class="form-block">
                <label for="carOwner" class="form-block__label">
                    Перевозчик
                </label>
                <select 
                    class="form-block__input" 
                    id="carOwner"
                    [(ngModel)]="request.car" 
                    (change)="onCarChange()" 
                    [compareWith]="byId"
                >
                    <option [ngValue]="undefined"></option>
                    <option *ngFor="let car of cars" [ngValue]="car">
                        {{car.owner}}
                    </option>
                </select>
            </div>
            <div class="form-block">
                <label for="carVat" class="form-block__label">
                    Перевозка НДС включен
                </label>
                <input 
                    disabled 
                    type="checkbox" 
                    [ngModel]="request.carVat" 
                    class="form-block__input" 
                    id="carVat"
                >
            </div>
            <div class="form-block">
                <label for="unit" class="form-block__label">
                    Единицы измерения
                </label>
                <input 
                    disabled 
                    type="text" 
                    class="form-block__input"
                    id="unit"
                    [(ngModel)]="request.unit"
                >
            </div>
            <div class="form-block">
                <label for="freightPrice" class="form-block__label">
                    Цена перевозки за ед.
                </label>
                <input 
                    disabled 
                    type="number" 
                    class="form-block__input"
                    id="freightPrice"
                    [ngModel]="request.freightPrice"
                    (change)="onFreightPriceChange()"
                >
            </div>
            <div class="form-block">
                <label for="carCategoryName" class="form-block__label">
                    Категория машины
                </label>
                <select 
                    disabled 
                    class="form-block__input"
                    id="carCategoryName"
                    [ngModel]="request.car?.carCategory?.id"
                >
                    <option *ngFor="let carCategory of carCategories" [ngValue]="carCategory.id">
                        {{carCategory.name}}
                    </option>
                </select>
            </div>
        </div>
        <div *ngIf="!request.isLong" class="form-block-adding-block">
            <div class="form-block">
                <label for="amountIn" class="form-block__label">
                    Вход, тн
                </label>
                <input 
                    type="number" 
                    class="form-block__input"
                    id="amountIn"
                    [(ngModel)]="request.amountIn"
                >
            </div>
            <div class="form-block">
                <label for="amountOut" class="form-block__label">
                    Выход, тн
                </label>
                <input 
                    type="number" 
                    class="form-block__input"
                    id="amountOut"
                    [(ngModel)]="request.amountOut"
                    (change)="onAmountChange()"
                >
            </div>
            <div class="form-block">
                <label for="freightCost" class="form-block__label">
                    Стоимость перевозки
                </label>
                <input 
                    disabled 
                    type="number" 
                    class="form-block__input"
                    id="freightCost"
                    [ngModel]="request.freightCost"
                    (change)="calcProfit()"
                >
            </div>
            <div class="form-block">
                <label for="sellingCost" class="form-block__label">
                    Выручка
                </label>
                <input 
                    disabled 
                    type="number" 
                    class="form-block__input"
                    id="sellingCost"
                    [ngModel]="request.sellingCost"
                >
            </div>
            <div class="form-block">
                <label for="profit" class="form-block__label">
                    Прибыль
                </label>
                <input 
                    disabled 
                    type="number" 
                    class="form-block__input"
                    id="profit"
                    [ngModel]="request.profit"
                >
            </div>
        </div>

        <div class="form-block">
            <label for="reward" class="form-block__label">
                Вознаграждение
            </label>
            <input 
                type="number" 
                class="form-block__input"
                id="reward"
                [(ngModel)]="request.reward"
                (change)="calcProfit()"
            > 
        </div>
        <div class="form-block">
            <label for="comment" class="form-block__label">
                Комментарий
            </label>
            <input 
                type="text" 
                class="form-block__input"
                id="comment"
                [(ngModel)]="request.comment"
            >   
        </div>
        <button 
            (click)="createOrUpdate(request, parentRequestId)"
            class="app-btn gray-btn"
        >
            Сохранить
        </button>
    </div>
</ngx-smart-modal>
<app-client-editor (changed)="onClientAdd()"></app-client-editor>
<app-supplier-editor (changed)="onSupplierAdd()"></app-supplier-editor>